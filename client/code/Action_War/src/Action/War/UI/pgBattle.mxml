<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer xmlns:fx="http://ns.adobe.com/mxml/2009"
				   xmlns:s="library://ns.adobe.com/flex/spark"
				   implements="Action.Core.Page.IGamePage,Action.Display.Drawing.ICanvasContainer"
				   xmlns:mx="library://ns.adobe.com/flex/mx" width="760" height="600" backgroundColor="#000000">
	<fx:Declarations>
		<!-- 将非可视元素（例如服务、值对象）放在此处 -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import Action.Core.Flow.Workflow;
			import Action.Core.GamePlugins;
			import Action.Display.Decorator.CommonDisplayDecorator;
			import Action.Display.Decorator.DisplayDecoratorBuilder;
			import Action.Display.Decorator.IDisplayDecorator;
			import Action.Display.Drawing.BitmapHelper;
			import Action.Display.Drawing.CanvasGraphics;
			import Action.Display.Drawing.MoviePlayer;
			import Action.Model.BattleReport;
			import Action.Model.BattleUnit;
			import Action.Resource.CommonResource;
			import Action.Resource.Flow.LoadImageActivity;
			import Action.War.Report.BattleReportManager;
			import Action.War.Resource.BattleUnitResource;
			import Action.War.WarModule;
			
			import Util.NumberWrapper;
			
			import mx.controls.Alert;
			import mx.controls.Image;
			import mx.core.IVisualElement;
			import mx.events.FlexEvent;
			
			private var _canvasGraphics:CanvasGraphics;
			private var _moviePlayer:MoviePlayer;
			
			public var battleReportManager:BattleReportManager;
						
			public function onLoad():void
			{
				//加载背景
				_bcMain.setStyle("backgroundImage", CommonResource.imageSection.get(WarModule.BgUrl));
				
				//生成网格
				for(var i:int = 0; i<5; i++)
				{
					for(var j:int = 0; j<14; j++)
					{
						var cell:BorderContainer = new BorderContainer();
						cell.setStyle("borderWeight", 1);
						cell.setStyle("backgroundAlpha", 0.3);
						cell.setStyle("backgroundColor", "#000044");
						cell.setStyle("borderColor", "#00ffff");
						cell.width = cell.height = 50;
						cell.x = j * 50;
						cell.y = i * 50;						
						_bcGrid.addElement(cell);
						
						var lbl:Label = new Label();
						lbl.x = 20;
						lbl.y = 20;
						lbl.setStyle("color", "#ffff00");
						lbl.text = (j * 5 + i).toString();
						cell.addElement(lbl);
					}
				}
				
				//装饰控件
				var decorator1:CommonDisplayDecorator = new CommonDisplayDecorator();
				decorator1.color = "#ffff00";
				var decorator2:CommonDisplayDecorator = new CommonDisplayDecorator();
				decorator2.color = "#ff8800";
				DisplayDecoratorBuilder.create([_lblGrid, _lblPlay])
					.appendDecorator(MouseEvent.MOUSE_OVER, decorator1)
					.appendDecorator(MouseEvent.MOUSE_OUT, decorator2)
					.build();
				
				loadMovie();				
			}
			
			private function loadMovie():void
			{
				_canvasGraphics = new CanvasGraphics(this);
				_canvasGraphics.clear();
				GamePlugins.console.clear();
				
				battleReportManager.play(_canvasGraphics);
				_moviePlayer = battleReportManager.moviePlayer;
				_sldProgress.maximum = _moviePlayer.movie.maxFrame;
				
				_moviePlayer.removeEventListener(MoviePlayer.Event_Goto, onMovieGoto);
				_moviePlayer.removeEventListener(MoviePlayer.Event_Stop, onMovieStop);
				_moviePlayer.addEventListener(MoviePlayer.Event_Goto, onMovieGoto);
				_moviePlayer.addEventListener(MoviePlayer.Event_Stop, onMovieStop);
			}
			
			private function onMovieGoto(e:Event):void
			{
				_sldProgress.value = _moviePlayer.currentFrame;
			}
			
			private function onMovieStop(e:Event):void
			{
				_btnPlay.label = "重播";
			}
			
			public function onUnload():void
			{
				
			}
			
			public function getCanvas():BorderContainer
			{
				return _bcCanvas;
			}
			
			
			protected function _lblGrid_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				_lblGrid.text = (_bcGrid.visible = !_bcGrid.visible) ? "隐藏网格" : "显示网格";
			}
			
			protected function _lblPlay_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				_canvasGraphics.clear();
				GamePlugins.console.clear();
				battleReportManager.play(_canvasGraphics);
			}
			
			protected function _sldProgress_valueCommitHandler(event:FlexEvent):void
			{
				// TODO Auto-generated method stub
				//GamePlugins.console.writeLine(_sldProgress.value);
				//_moviePlayer.goto(_sldProgress.value);
			}
			
			protected function _btnPlay_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				if(_btnPlay.label == "重播")
					loadMovie();
				else
					_moviePlayer.pause(_moviePlayer.running);
				_btnPlay.label = _moviePlayer.running ? "暂停" : "播放";
			}
			
			protected function _btnGrid_clickHandler(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				_bcGrid.visible = !_bcGrid.visible;
			}
			
		]]>
	</fx:Script>
	<s:Label id="_lblPlayer1" x="50" y="40" color="#ffff00" fontFamily="微软雅黑" fontSize="28"
			 fontWeight="bold" text=" 神仙一枝花"  buttonMode="true"/>
	<s:Label id="_lblVS" x="350" y="40" color="#00ff00" fontFamily="微软雅黑" fontSize="28"
			 fontWeight="bold" text=" VS " />
	<s:Label id="_lblPlayer2" x="550" y="40" color="#ffff00" fontFamily="微软雅黑" fontSize="28"
			 fontWeight="bold" text="万寿落雪"  buttonMode="true"/>
	<s:BorderContainer id="_bcMain" y="100" width="100%" height="400" useHandCursor="false">		
		<s:BorderContainer id="_bcGrid" width="700" height="250" borderColor="#0000ff" borderWeight="0"
						   backgroundAlpha="0" x="30" y="75" visible="false">			
		</s:BorderContainer>
		<s:BorderContainer id="_bcCanvas" width="700" height="250" x="30" y="75" borderVisible="false"
						   backgroundAlpha="0">
			<s:BorderContainer id="_bcLayerEffect" width="100%" height="100%" backgroundAlpha="0" borderVisible="false">
				<s:BorderContainer id="_bcLayerText" width="100%" height="100%" backgroundAlpha="0" borderVisible="false">
					
				</s:BorderContainer>
			</s:BorderContainer>
		</s:BorderContainer>
	</s:BorderContainer>
	<s:Label id="_lblGrid" x="490" y="540" color="#ff8800" fontFamily="华文楷体" fontSize="28" visible="false"
			 fontWeight="bold" text="显示网格" buttonMode="true" click="_lblGrid_clickHandler(event)"/>
	<s:Label id="_lblPlay" x="620" y="540" color="#ff8800" fontFamily="华文楷体" fontSize="28" visible="false"
			 fontWeight="bold" text="重新播放" buttonMode="true" click="_lblPlay_clickHandler(event)" />
	<s:HSlider id="_sldProgress" x="20" y="530" width="720" enabled="false" valueCommit="_sldProgress_valueCommitHandler(event)"/>
	<s:Button id="_btnPlay" x="20" y="550" label="暂停" click="_btnPlay_clickHandler(event)"/>
	<s:Button id="_btnGrid" x="100" y="550" label="网格" click="_btnGrid_clickHandler(event)"/>
</s:BorderContainer>
